<!-- Node Registration -->
<script type="text/javascript">

	/** Type Registration **/
	RED.nodes.registerType('insteon-device-config',{
		category: 'config',
		color: '#2e88c5',
		align: 'left',
		defaults: {
			modem: { value: '', type: 'insteon-modem-config' },
			name: { value: '' },
			address: { value: '', validate: RED.validators.regex(/[0-9A-F]{2}.[0-9A-F]{2}.[0-9A-F]{2}/) },
			deviceType: { value: '' },
		},
		inputs: 0,
		outputs: 0,
		icon: 'light.png',
		label: function(){ return this.name || 'Insteon Device' },

		//#region Lifecycle Methods

		oneditprepare: function(){
			let node = this;

			// Getting function library
			let deviceConfig = RED.nodes.getType("insteon-device-config");

			// Rendering settings
			deviceConfig.renderTabs();

			// Setting up lookup button
			$('#node-config-lookup-deviceType').click(_ => deviceConfig.onLookupDeviceType(node));
			$('#node-config-sync-database').click(_ => deviceConfig.onSyncDatabase(node));

			// deviceConfig.getDatabase(node.id, console.log, console.error);
		 },

		//#endregion

		//#region Render Methods

		renderTabs: function(){

			// Creating tabs with on change function
			let tabs = RED.tabs.create({
				id: "node-config-tabs",
				onchange: function(tab) {
					$("#node-config-tabs-content").children().hide();
					$("#" + tab.id).show();
				}
			});

			// Adding tabs
			tabs.addTab({
				id: "node-config-tab-database",
				label: "Database"
			});

			tabs.addTab({
				id: "node-config-tab-scenes",
				label: "Scenes"
			});
		},

		renderDatabaseTable: function(records){
			let insteon = RED.nodes.getType("insteon-modem-config");
			let deviceConfig = RED.nodes.getType("insteon-device-config");

			// Looping over links
			for (let link of records){

				//Grabbing data from links
				let address = `0x${link.address.map(a => insteon.toHex(a).substring(2).toUpperCase()).join('')}`;
				let active = link.Type.active ? '✓' : '×';
				let type = link.Type.control === 1 ? 'Controller' : 'Responder';
				let group = link.group.toString();
				let device = link.device.map(insteon.toHex).map(a => a.substring(2)).join('.').toUpperCase();
				let level = link.onLevel.toString();
				let rate = link.rampRate.toString();
				let highWater = link.Type.highWater ? '~' : '-';

				let recordRow = $('<tr>', { style:'white-space:nowrap' } );

				$('<td>', {html: address}).appendTo(recordRow);
				$('<td>', {html: active}).appendTo(recordRow);
				$('<td>', {html: device}).appendTo(recordRow);
				$('<td>', {html: type}).appendTo(recordRow);
				$('<td>', {html: group}).appendTo(recordRow);
				$('<td>', {html: level}).appendTo(recordRow);
				$('<td>', {html: rate}).appendTo(recordRow);
				$('<td>', {html: highWater}).appendTo(recordRow);

				// Appending device row to links table
				recordRow.appendTo($('#node-config-database-body'));
			}


		},

		//#endregion

		//#region Handlers

		onLookupDeviceType: function(node){
			let deviceConfig = RED.nodes.getType("insteon-device-config");

			let address = node.address;
			let modemId = node.modem;

			$.ajax({
				method: 'GET',
				dataType: "JSON",
				url: `insteon/device/type?modemId=${modemId}&address=${address}`,
				success: deviceConfig.onDeviceType,
				failure: deviceConfig.onDeviceTypeFailure
			});

		},

		onDeviceType: function(data){
			// Getting device type from data
			const deviceType = data.class;

			// Setting device type box to correct value
			$('#node-config-input-deviceType').val(deviceType);
		},

		onDeviceTypeFailure: function(error){
			console.error(data);
		},

		onSyncDatabase: function(node){
			let deviceConfig = RED.nodes.getType("insteon-device-config");

			deviceConfig.getDatabase(node.id, deviceConfig.renderDatabaseTable, console.error);
		},

		//#endregion

		//#region Data Methods

		getDatabase: function(id, success, error){
			$.ajax({
				method: 'GET',
				dataType: "JSON",
				url: 'insteon/device/database?deviceId=' + id,
				success,
				error
			});
		},

		//#endregion
	});

</script>

<!-- Node Configuration -->
<script type="text/html" data-template-name="insteon-device-config">
	<!-- Modem -->
	<div class="form-row">
		<label for="node-config-input-modem">Insteon Modem</label>
		<input type="text" id="node-config-input-modem" placeholder="/dev/usb123">
	</div>

	<!-- Name -->
	<div class="form-row">
		<label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-config-input-name" placeholder="Name">
	</div>

	<!-- Address -->
	<div class="form-row">
		<label for="node-config-input-address"><i class="icon-tag"></i>Address</label>
		<input type="text" id="node-config-input-address" placeholder="aa.bb.cc" />
	</div>

	<!-- Device Type -->
	<div class="form-row">
		<label for="node-config-deviceType"><i class="icon-tag"></i>Device Type</label>
		<select id="node-config-deviceType" style="width: inital">
			<optgroup label="General Devices">
				<option value="InsteonDevice" selected="selected">Insteon Device</option>
			</optgroup>

			<optgroup label="Dimmable Lighting Controls">
				<option value="DimmableLightingDevice">Dimmable Lighting Device</option>
				<option value="KeypadDimmer">Keypad Dimmer</option>
			</optgroup>

			<optgroup label="Switched Lighting Controls">
				<option value="SwitchedLightingDevice">Switched Lighting Device</option>
			</optgroup>

			<optgroup label="Sensors and Actuators Devices">
				<option value="SensorActuatorDevice">Sensor & Actuator Device</option>
				<option value="IOLinc">IO Linc</option>
			</optgroup>

			<optgroup label="Security, Health, Safety Devices">
				<option value="SecurityDevice">Security Device</option>
				<option value="MotionSensor">Motion Sensor</option>
				<option value="LeakSensor">Leak Sensor</option>
				<option value="OpenCloseSensor">Open Close Sensor</option>
			</optgroup>
		</select>

		<!-- Device Type Search Button -->
		<a id='node-config-lookup-deviceType' class='red-ui-button'>
			<i id='node-config-lookup-deviceType-icon' class='fa fa-search'></i>
		</a>
	</div>

	<!-- Tab Strip -->
	<div class="form-row">
		<ul style="margin-bottom: 20px;" id="node-config-tabs" />
	</div>

	<!-- Tab Content -->
	<div id="node-config-tabs-content" style="min-height:150px;">
		<!-- Database Tab -->
		<div id="node-config-tab-database" style="display:none">
			<div class="form-row">
				<!-- Database Content -->
				<div>
					<a id='node-config-sync-database' class='red-ui-button' style="width: 100%">
						<i id='node-config-sync-database-icon' class='fa fa-refresh'/> Sync Database
					</a>
					<table width='100%'>
						<thead>
							<tr>
								<th style='text-align: left;'>Address</th>
								<th style='text-align: left;'>Active</th>
								<th style='text-align: left;'>Device</th>
								<th style='text-align: left;'>Type</th>
								<th style='text-align: left;'>Group</th>
								<th style='text-align: left;'>Level</th>
								<th style='text-align: left;'>Rate</th>
								<th style='text-align: left;'>~</th>
							</tr>
						</thead>
						<tbody id='node-config-database-body'></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Scenes Tab -->
		<div id="node-config-tab-scenes" style="display:none">
			<div class="form-row">
				This is the scenes tab
			</div>
		</div>
</script>

<!-- Help Panel -->
<script type="text/html" data-help-name="insteon-device-config">
	<h3>Info</h3>
	<p>Represents one physical insteon device.</p>

	<p>Drag this node onto the pallet, assign it the insteon device ID and give it a name. </p>

	<p>The node will keep track of the current state of the physical device.</p>
</script>