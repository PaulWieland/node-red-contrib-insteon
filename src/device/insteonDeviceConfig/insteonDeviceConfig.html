<!-- Node Registration -->
<script type="text/javascript">	
	/** Type Registration **/
	RED.nodes.registerType('insteon-device-config',{
		category: 'config',
		color: '#2e88c5',
		align: 'left',
		defaults: {
			modem: { value: '', type: 'insteon-modem-config' },
			name: { value: '' },
			address: { value: '', function(v){ return RED.nodes.getType("insteon-modem-config").validateDeviceAddress(v) } },
			cache: { value: '' },
		},
		oneditprepare: function(){
			let insteon = RED.nodes.getType("insteon-modem-config");
			insteon.device = RED.nodes.getType("insteon-device-config");
			
			/* parse the cache json */
			let cache = insteon.device.readCache();
			
			insteon.device.renderDescription(cache);
		
			/* Setting up settings accordion */
			$('#accordion').accordion({heightStyle: 'fill'});
		},
		inputs: 0,
		outputs: 0,
		icon: 'light.png',
		label: function(){ return this.name || 'Insteon Device' },
		
		
		readCache: function(){
			let cache = {};
			
			/* unserialize the cache */
			try{
				cache = JSON.parse($("#node-config-input-cache").val());
			}catch(e){}
			
			return cache;
		},
		writeCache: function(cache){
			/* Update the cache input */
			$('#node-config-input-cache').val(JSON.stringify(cache));
			
			/* Trigger a deploy to save the cache. This is necessary to prevent the UI from going out of sync with the hardware */
			$("#node-config-dialog-ok").click();
			$("#red-ui-header-button-deploy-icon").click();			
		},
		
		/* Assemble an object containing all data needed to make an ajax request that will update a device's configuration
		 * The data must be serialized in order for it to be properly posted by postConfig and decoded by the server
		 */
		serializeConfig: function(){
			let data = {};
			
			data.plmConfigNode = $("#node-config-input-modem").val();
			data.address = $('#node-config-input-address').val();

			/* Add properties for each checkbox and set value to checked state */
			$(".insteon-device-config:checkbox").map((i,e) => {
				data[$(e).prop("name")] = $(e).prop("checked");
			});
			
			/* Add properties for each input */
			$(".insteon-device-config").not(":checkbox").map((i,e) => {
				data[$(e).prop("name")] = $(e).val();
			});
		
			return JSON.stringify(data);
		},
		
		postConfig: function(args){
			$.ajax({
				method: 'POST',
				dataType: 'JSON',
				contentType: 'application/json',
				url: args.url,
				data: args.data,
				success: args.success,
				error: args.error,
			});
		},
		
		//#region render device config functions
		onDeviceEditPrepare: function(node, url){
			/* import the JS functions from the modem & top level device config node */
			let insteon = RED.nodes.getType("insteon-modem-config");
			insteon.device = RED.nodes.getType("insteon-device-config");
			
			/* parse the cache json into an object */
			let cache = insteon.device.readCache();
		
			/* put the device description in the UI */
			$('#device-description').text(cache.info.description);
					
			/* render the links table */
	
			/* setup the write config button */
			$('#update-device-config').click(function(){
				$('#update-device-config').addClass('disabled');
				$('#update-device-config').prop('disabled', true);
			
				insteon.device.postConfig({
					url: url,
					data: insteon.device.serializeConfig(),
					success: data => {
						$('#update-device-config').removeClass('disabled');
						$('#update-device-config').prop('disabled', false);
					
						cache.config = data.configCache;
						cache.extendedConfig = data.extendedConfigCache;
						insteon.device.writeCache(cache);
					},
					error: e => {
						$('#update-device-config').removeClass('disabled');
						$('#update-device-config').prop('disabled', false);

						insteon.sendErrorToDebugConsole(node.id,`${e.responseJSON.message}: ${e.responseJSON.caught}`);						
					}
				});
			});

			/* Setting up settings accordion */
			$('#accordion').accordion({heightStyle: 'fill'});
		}
		
		//#region
	});


</script>

<!-- Node Configuration -->
<script type="text/x-red" data-template-name="insteon-device-config">
	<div class="form-row">
		<label for="node-config-input-modem">Insteon Modem</label>
		<input type="text" id="node-config-input-modem" placeholder="/dev/usb123">
	</div>
	<div class="form-row">
		<label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-config-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-config-input-address"><i class="icon-tag"></i>Address</label>
		<input type="text" style="width: 80px" id="node-config-input-address" placeholder="AA.BB.CC" />
		<span id="device-description"></span>		
	</div>
	<div class="form-row">
		<label for="node-config-input-cache"><i class="icon-tag"></i>cache</label>
		<input type="text" id="node-config-input-cache" placeholder="" disabled="true" />
	</div>

</script>

<!-- Help Panel -->
<script type="text/x-red" data-help-name="insteon-device-config">
	<h3>Info</h3>
	<p>Represents one physical insteon device.</p>

	<p>Drag this node onto the pallet, assign it the insteon device ID and give it a name. </p>

	<p>The node will keep track of the current state of the physical device.</p>
</script>