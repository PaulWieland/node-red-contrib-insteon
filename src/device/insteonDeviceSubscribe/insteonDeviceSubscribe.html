<!-- Node Registration -->
<script type="text/javascript">

	//#region Event Methods

	function onInputCheck(n){
		if($(this).prop("checked")) {
				node.selectedEvents.push({
					id: $(this).prop('id'),
					label: $("label[for='" + $(this).attr('id') + "']").text(),
					cmd1: $(this).attr('data-cmd1'),
					cmd2: $(this).attr('data-cmd2')
				});
			}
	}

	//#endregion

	//#region Lifecycle Methods

	function onEditPrepare(){
		// This: the current node

			// Select the value in the subtype drop down
			$(`#node-input-subtype option[value="${this.subtype}"]`).attr('selected', 'selected');

			// Check the boxes for the events that have been selected
			this.selectedEvents.map(el => $(`#${el.id}`).prop('checked',true));
	}

	function onEditSave(){
			// This: the current node
			this.selectedEvents = [];

		// reach which events were selected and push them into the config
		$(".event-selection input").each(onInputCheck);
	}

	//#endregion

	//#region Type Registration

	RED.nodes.registerType('insteon-device-subscribe',{
		category: 'Insteon',
		color: '#2e88c5',
		align: 'left',
		defaults: {
			device: { value: '', type: 'insteon-device-config' },
			name: { value: '' },
			subtype: {value: ''},
			selectedEvents: { value: null }
		},
		inputs: 0,
		outputs: 1,
		icon: 'bridge.png',
		label: function(){ return this.name || RED.nodes.node(this.device) !== null ? `${RED.nodes.node(this.device).name} In` : 'Device In' },
		paletteLabel: 'Device In',
		oneditprepare: onEditPrepare,
		oneditsave: onEditSave
	});

	//#endregion

</script>

<!-- Node Configuration -->
<script type="text/x-red" data-template-name="insteon-device-subscribe">
	<div class="form-row">
		<label for="node-input-device">Insteon Device</label>
		<input type="text" id="node-input-device" placeholder="xyz">
	</div>
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-input-subtype">Message Type</label>
		<select id="node-input-subtype">
			<option value="" label="All" />
			<option value="0x6" label="Broadcast (Physically Triggered)" />
			<option value="0x1" label="Acknowledge (Response to Command)" />
		</select>
	</div>
	<div class="form-row event-selection">
		<strong>Device Events</strong>
		<ul>
			<li><input type="checkbox" title="Turned On"            id="node-input-event-turned-on"            data-cmd1="0x11" data-cmd2="" class="dimmer onoff" style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-turned-on">Turned On</label></li>
			<li><input type="checkbox" title="Turned Off"           id="node-input-event-turned-off"           data-cmd1="0x13" data-cmd2="" class="dimmer onoff" style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-turned-off">Turned Off</label></li>
			<li><input type="checkbox" title="Fast On"              id="node-input-event-fast-on"              data-cmd1="0x12" data-cmd2="" class="dimmer onoff" style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-fast-on">Fast On</label></li>
			<li><input type="checkbox" title="Fast Off"             id="node-input-event-fast-off"             data-cmd1="0x14" data-cmd2="" class="dimmer onoff" style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-fast-off">Fast Off</label></li>
			<li><input type="checkbox" title="Brightened"           id="node-input-event-brightened"           data-cmd1="0x17" data-cmd2="0x1" class="dimmer"    style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-brightened">Brightened</label></li>
			<li><input type="checkbox" title="Dimmed"               id="node-input-event-dimmed"               data-cmd1="0x17" data-cmd2="0x0" class="dimmer"    style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-dimmed">Dimmed</label></li>
			<li><input type="checkbox" title="Stop Dimming"         id="node-input-event-stop-dimming"         data-cmd1="0x18" data-cmd2="0x0" class="dimmer"    style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-stop-dimming">Stop Dimming</label></li>

			<li><input type="checkbox" title="Heartbeat"            id="node-input-event-heartbeat"            data-cmd1="0x04" data-cmd2="" class="motion leak"  style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-heartbeat">Heartbeat</label></li>

			<li><input type="checkbox" title="Low Battery Detected" id="node-input-event-low-battery-detected" data-cmd1="0x70" data-cmd2="0x02" class="motion leak"  style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-low-battery-detected">Low Battery Detected</label></li>
			<li><input type="checkbox" title="Low Battery Cleared"  id="node-input-event-low-battery-cleared"  data-cmd1="0x70" data-cmd2="0x03" class="motion leak"  style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-low-battery-cleared">Low Battery Cleared</label></li>

			<li><input type="checkbox" title="Motion Detected"      id="node-input-event-motion-detected"      data-cmd1="0x11" data-cmd2="" class="motion"       style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-motion-detected">Motion Detected</label></li>
			<li><input type="checkbox" title="Motion Timeout"       id="node-input-event-motion-timeout"       data-cmd1="0x13" data-cmd2="" class="motion"       style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-motion-timeout">Motion Timeout</label></li>
			<li><input type="checkbox" title="Dusk Detected"        id="node-input-event-dusk-detected"        data-cmd1="" data-cmd2="" class="motion"       style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-dusk-detected">Dusk Detected</label></li>
			<li><input type="checkbox" title="Dawn Detected"        id="node-input-event-dawn-detected"        data-cmd1="" data-cmd2="" class="motion"       style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-dawn-detected">Dawn Detected</label></li>

			<li><input type="checkbox" title="Water Detected"       id="node-input-event-water-detected"       data-cmd1="0x70" data-cmd2="0x00" class="leak"         style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-water-detected">Water Detected</label></li>
			<li><input type="checkbox" title="Dry Detected"         id="node-input-event-dry-detected"         data-cmd1="0x70" data-cmd2="0x01" class="leak"         style="width: 20px; margin: 0 2px 1px 2px;"> <label style="width: 200px" for="node-input-event-dry-detected">Dry Detected</label></li>
		</ul>
	</div>
</script>

<!-- Help Panel -->
<script type="text/x-red" data-help-name="insteon-device-subscribe">
	<h3>Info</h3>
	<p>Subscribe to event changes for an insteon device.</p>

	<p>Use this node to start a flow when a switch is turned on, motion is detected, etc.</p>
</script>