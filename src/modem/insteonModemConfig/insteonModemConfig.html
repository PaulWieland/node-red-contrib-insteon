<!-- Node Registration -->
<script type='text/javascript'>

	/** Type Registration **/
	RED.nodes.registerType('insteon-modem-config',{
		category: 'config',
		defaults: {
			path: { value: '', required: true }
		},
		label: function(){
			return this.path || 'Insteon Modem'
		},

		//#region Lifecycle Methods

		oneditprepare: function(){
			let node = this;

			// Getting function library
			let insteon = RED.nodes.getType("insteon-modem-config");

			// PLM Path UI
			try { $('#node-config-input-path').autocomplete( 'destroy' ); }
			catch(err) { }

			// Rendering settings
			insteon.renderTabs();

			// PLM Info
			if(node.path != '')
				insteon.getModemInfo(node.path, insteon.renderModemInfo, e => node.error(e));

			// Setting up lookup button
			$('#node-config-lookup-modems').click(insteon.onLookupPaths);
			$('#node-config-info-modems').click(insteon.onGetInfo);

			// PLM links table
			insteon.getModemLinks(node.id, insteon.renderLinksTable, e => node.error(e));
		 },

		 //#endregion

		//#region Handlers

		onGetInfo: function(){
			let insteon = RED.nodes.getType("insteon-modem-config");

			let path = $('#node-config-input-path').val();

			insteon.getModemInfo(path, insteon.renderModemInfo, _ => insteon.renderModemInfo());
		},

		onLookupPaths: function(){
			let insteon = RED.nodes.getType("insteon-modem-config");

			insteon.getInsteonPorts(insteon.renderInsteonPorts, e => sendErrorToDebugConsole(node.id, e));
		},

		onAddDevice: function(){
			submitAddress(this, 'addNewDevice', $('#new_device_address').val());
		},

		onRemoveDevice: function(){
			submitAddress(this, 'removeDevice', $('#device_address_to_remove').val());
		},

		//#endregion

		//#region Render Methods

		renderInsteonPorts: function(ports){
			// Getting function library
			let insteon = RED.nodes.getType("insteon-modem-config");

			// Auto complete config
			let autoConfig = {
				source: ports.map(_ => _.path),
				minLength: 0,
				close: () => {
					$('#node-config-input-path').autocomplete('destroy');

					insteon.onGetInfo();
				}
			};

			// Creating autocomplete
			$('#node-config-input-path')
				.autocomplete(autoConfig)
				.autocomplete('search', '');
		},

		renderLinksTable: function(links){

			// Getting function library
			let insteon = RED.nodes.getType("insteon-modem-config");

			// If no links then do nothing
			if(links.length === 0)
				return;

			// Getting all device config nodes
			let devices = [];
			RED.nodes.eachConfig(c => c.type === 'insteon-device-config' ? devices.push(c) : '');

			// Hiding links hint for no PLM
			$('#linkMessage').hide();

			// Clearing links and address elements
			$('#links').empty();
			$('#device_address_to_remove').empty();

			// Sorting links by group
			links = links.sort((a, b) => a.group > b.group ? 1 : b.group > a.group ? -1 : 0)
			             .sort((a, b) => a.type === b.type ? 0 : a.type < b.type ? 1 : -1);

			// For each link in PLM render a device row
			links.forEach(link => {
				// Get the linked device's configuration node, if there is one
				let deviceConfigNode = insteon.getDeviceNode(link.device);

				// /* Create the table cell for the device. If the device has a config node,
				// 	make it a clickable link to take the user to the edit panel for the
				// 	deviceConfig node.
				// */
				// let deviceCell = $('<td>', { style:'white-space:nowrap' } );

				// if(deviceConfigNode === null){
				// 	deviceCell.text(`${insteon.addressToString(link.device)}`);
				// }
				// else{
				// 	$('<a>', {
				// 		href: '#',
				// 		html: `${insteon.addressToString(link.device)}: ${deviceConfigNode.name}`,
				// 		click: function(e){
				// 			e.preventDefault();
				// 			RED.editor.editConfig('', 'insteon-device-config', deviceConfigNode.id);
				// 		}
				// 	}).appendTo(deviceCell);
				// }

				// Creating device row to hold device info
				const row = insteon.renderDeviceRow(link);

				// Appending device row to links table
				row.appendTo($('#links'));

				// // Option text will be device id or device name
				// let optionText = deviceConfigNode === null ? insteon.addressToString(link.device)
				// 																					: `${insteon.addressToString(link.device)}: ${deviceConfigNode.name}`;

				// Populate the select options in the remove device drop down with option text
				// $('<option/>', {
				// 	value: `${insteon.addressToString(link.device)}`,
				// 	html: optionText
				// }).appendTo($('#device_address_to_remove'));

			});
		},

		renderDeviceRow: function(link){
			// Getting function library
			let insteon = RED.nodes.getType("insteon-modem-config");

			// Table row
			let row = $('<tr/>');

			const type = link.type === 1 ? 'Controller' : 'Responder';
			const device = insteon.addressToString(link.device);
			const scene = link.group;
			const data1 = insteon.toHex(link.linkData[0]);
			const data2 = insteon.toHex(link.linkData[1]);
			const data3 = insteon.toHex(link.linkData[2]);

			const columns = [type, device, scene, data1, data2, data3].map(_ => $('<td>', {text: _}).appendTo(row));

			// Returning row
			return row;
		},

		renderModemInfo: function(data){
			// Getting function library
			let insteon = RED.nodes.getType("insteon-modem-config");

			let addressString = '';
			let descString = '';

			if(data != undefined){
				addressString = insteon.addressToString(data.id);
				descString = data.info.description;
			}

			$('#insteon-address').text(addressString);
			$('#insteon-desc').text(descString);
		},

		renderTabs: function(){
			// Creating tabs with on change function
			let tabs = RED.tabs.create({
				id: "node-config-tabs",
				onchange: function(tab) {
					$("#node-config-tabs-content").children().hide();
					$("#" + tab.id).show();
				}
			});

			// Adding tabs
			tabs.addTab({
				id: "node-config-tab-config",
				label: "Info/Config"
			});

			tabs.addTab({
				id: "node-config-tab-database",
				label: "Database"
			});

			tabs.addTab({
				id: "node-config-tab-scenes",
				label: "Scenes"
			});

			tabs.addTab({
				id: "node-config-tab-controllers",
				label: "Controllers"
			});

		},

		//#endregion

		//#region Data Fetching Methods

		getInsteonPorts: function(success, error){
			$.ajax({
				method: 'GET',
				dataType: "JSON",
				url: 'insteon/ports',
				success,
				error
			});
		},

		getModemInfo: function(path, success, error){
			$.ajax({
				method: 'GET',
				dataType: "JSON",
				url: 'insteon/modem/info',
				data: {
					path
				},
				success,
				error
			});
		},

	 	getModemLinks: function(id, success, error){
			$.ajax({
				method: 'GET',
				dataType: "JSON",
				url: 'insteon/modem/links',
				data: {
					id
				},
				success,
				error
			});
		},

		manageDevice: function(id, address, action, success, error){
			$.ajax({
				method: 'post',
				dataType: 'json',
				url: 'insteon/device/manage',
				data: { id, action, address },
				success,
				error,
			});
		},

		//#endregion

		//#region Manage Methods

		/* Add New Insteon Device */
		submitAddress: function(node, action, address){
			$('#add_device,#remove_device').prop('disabled', true);

			manageDevice(node.id, address, action,
				data => {
					$('#add_device,#remove_device').prop('disabled', false);

					if(data.error){
						sendErrorToDebugConsole(node.id,data.message);
						return;
					}

					alert(data.message);

					$('#new_device_address').val('');
					renderLinksTable(data.links);
				},
				e => {
					$('#add_device,#remove_device').prop('disabled', false);

					sendErrorToDebugConsole(node.id,error);
				}
			);
		},

		//#endregion

		//#region Utility Methods

		/* Make a hex string for a Byte array */
		addressToString: function(address){
			return address.map(num => num.toString(16).toUpperCase().padStart(2, '0')).join('.');
		 },

		getDeviceNode: function(address){
			let devices = [];

			RED.nodes.eachConfig(c => c.type === 'insteon-device-config' ? devices.push(c) : null);

			return devices.find(d =>
				parseInt(d.address1, 16) === address[0] &&
				parseInt(d.address2, 16) === address[1] &&
				parseInt(d.address3, 16) === address[2]
			) || null;
		 },

		toHex: function(n){
			return `0x${n.toString(16).toUpperCase().padStart(2, '0')}`;
		}

		 //#endregion
	});

</script>

<!-- Node Configuration -->
<script type='text/html' data-template-name='insteon-modem-config'>

	<style>
		tr:nth-child(even) {
			background-color: #eee;
		}
	</style>

	<!-- Main Settings -->
	<div class='form-row'>
		<h2>Settings</h2>

		<label for='node-config-input-path'>Path</label>

		<input type='text' id='node-config-input-path' style='width:60%;'>

		<a id='node-config-lookup-modems' class='red-ui-button'>
			<i id='node-config-lookup-modems-icon' class='fa fa-search'></i>
		</a>

		<a id='node-config-info-modems' class='red-ui-button'>
			<i id='node-config-info-modems-icon' class='fa fa-info'></i>
		</a>
	</div>

	<!-- Tab Strip -->
	<div class="form-row">
		<ul style="margin-bottom: 20px;" id="node-config-tabs" />
	</div>

	<!-- Tab Content -->
	<div id="node-config-tabs-content" style="min-height:150px;">

		<!-- Scenes Tab -->
		<div id="node-config-tab-config" style="display:none">
			<div class="form-row">
				<div>
					<h2>Info</h2>
					<div>
						Address: <span id="insteon-address"></span>
					</div>
					<div>
						Type: <span id="insteon-desc"></span>
					</div>
				</div>
				<div>
					<h2>Config</h2>
					<div>
						Deadman: <span id="insteon-deadman"></span>
					</div>
				</div>
			</div>
		</div>

		<!-- Database Tab -->
		<div id="node-config-tab-database" style="display:none">
			<div class="form-row">
				<!-- Database Content -->
				<div>
					<p id='linkMessage'>Links can only be displayed after the PLM is connected.</p>
					<table width='100%'>
						<thead>
							<tr>
								<th style='text-align: left;'>Type</th>
								<th style='text-align: left;'>Device</th>
								<th style='text-align: left;'>Group</th>
								<th style='text-align: left;'>Data 1</th>
								<th style='text-align: left;'>Data 2</th>
								<th style='text-align: left;'>Data 3</th>
							</tr>
						</thead>
						<tbody id='links'></tbody>
					</table>
				</div>

			</div>
		</div>

		<!-- Scenes Tab -->
		<div id="node-config-tab-scenes" style="display:none">
			<div class="form-row">
				This is the scenes tab
			</div>
		</div>

		<!-- Scenes Tab -->
		<div id="node-config-tab-controllers" style="display:none">
			<div class="form-row">
				This is the controllers tab
			</div>
		</div>
	</div>
</script>

<!-- Help Panel -->
<script type='text/html' data-help-name='insteon-modem-config'>
	<h3>Info</h3>
	<p>Provides configuration options for a Insteon modem</p>
	<p>The search button should return a list of available Insteon PowerLinc Modems to choose from, or you can type in the location if known.</p>

	<h3>Example</h3>
	<p>/dev/ttyUSB0</p>
</script>